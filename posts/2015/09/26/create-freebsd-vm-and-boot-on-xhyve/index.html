<!DOCTYPE html>
<html lang="ja">

  <head>
    <script>
      var location_protocol = window.location.protocol;
      var location_host = window.location.host;
      var host = "https://tanb.me".split("://")[1];
      if ((host == location_host) && (location_protocol != "https:"))
      window.location.protocol = "https";
    </script>
      <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="canonical" href="https://tanb.me/posts/2015/09/26/create-freebsd-vm-and-boot-on-xhyve/index.html" />

    <title>  tanB &mdash; Create FreeBSD VM and boot on xhyve.
</title>

    <link rel="icon" href="https://tanb.me/theme/img/favicon.ico">


    <link rel="stylesheet" href="https://tanb.me/theme/css/pygments.css">
    <link rel="stylesheet" href="https://tanb.me/theme/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://tanb.me/theme/css/icons.css">

    <link rel="stylesheet/less" href="https://tanb.me/theme/less/style.less">
    <script src="https://tanb.me/theme/js/less.min.js" type="text/javascript"></script>

    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->


    <meta name="author" content="tanb">
    <meta name="description" content="TL;DR Create 10GB FreeBSD image using QEMU. Run the VM using xhyve. Mount host directory. Resize the image. Requisites OSX Homebrew xhyve $ brew install xhyve --HEAD QEMU $ brew install qemu FreeBSD installer. Download from https://www.freebsd.org/where.html Create Virtual Machine This Example creates 10GB image. $ cd ...">
  <meta name="tags" contents="xhyve FreeBSD, ">
  </head>

  <body>
<header class="header">
  <div class="container">
    <div class="header-image pull-left">
      <a class="nodec" href="/"><img src="https://tanb.me/theme/img/header-image.jpg"></a>
    </div>
    <div class="pull-right">
      <a class="header-translate" href="https://translate.google.com/translate?sl=ja&tl=en&ie=UTF-8&u=https%3A%2F%2Ftanb.me">English</a>
    </div>
    <div class="header-inner">
      <h1 class="header-name">
        <a class="nodec" href="/">tanB</a>
      </h1>
      <h3 class="header-text">Tomonori Tanabe</h3>
      <ul class="header-menu list-inline">
      </ul>
    </div>
  </div>
</header> <!-- /.header -->    <div class="container">
  <div class="post full-post">
    <h1 class="post-title">
      <a href="/posts/2015/09/26/create-freebsd-vm-and-boot-on-xhyve/" title="Permalink to Create FreeBSD VM and boot on xhyve.">Create FreeBSD VM and boot on xhyve.</a>
    </h1>
    <ul class="list-inline">
      <li class="post-date">
        <a class="text-muted" href="/posts/2015/09/26/create-freebsd-vm-and-boot-on-xhyve/" title="2015-09-26T12:47:00+09:00">Sat 26 September 2015</a>
      </li>
      <li class="post-category">
        <a href="https://tanb.me/category/misc.html">misc</a>
      </li>
        <li class="post-tag">
            <a href="/tag/xhyve FreeBSD.html">xhyve FreeBSD</a>        </li>
    </ul>
    <div class="post-content">
      <h1>TL;DR</h1>
<ul>
<li>Create 10GB FreeBSD image using QEMU.</li>
<li>Run the VM using xhyve.</li>
<li>Mount host directory.</li>
<li>Resize the image.</li>
</ul>
<h1>Requisites</h1>
<ul>
<li>OSX</li>
<li><a href="http://brew.sh">Homebrew</a></li>
<li><a href="https://github.com/mist64/xhyve">xhyve</a></li>
</ul>
<div class="highlight"><pre><span class="nv">$ </span>brew install xhyve --HEAD
</pre></div>


<ul>
<li><a href="http://www.qemu.org">QEMU</a></li>
</ul>
<div class="highlight"><pre><span class="nv">$ </span>brew install qemu
</pre></div>


<ul>
<li>FreeBSD installer. Download from https://www.freebsd.org/where.html</li>
</ul>
<h1>Create Virtual Machine</h1>
<ul>
<li>This Example creates 10GB image.</li>
</ul>
<div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> /Path/to/workdir
<span class="nv">$ </span>qemu-img create -f raw VM10G.raw 10G
Formatting <span class="s1">&#39;VM10G.raw&#39;</span>, <span class="nv">fmt</span><span class="o">=</span>raw <span class="nv">size</span><span class="o">=</span>10737418240
<span class="nv">$ </span>ls
FreeBSD-10.2-RELEASE-amd64-bootonly.iso VM10G.raw
</pre></div>


<h1>Install FreeBSD</h1>
<div class="highlight"><pre><span class="nv">$ </span>qemu-system-x86_64 -m <span class="m">256</span> -hda VM10G.raw -cdrom FreeBSD-10.2-RELEASE-amd64-bootonly.iso
WARNING: Image format was not specified <span class="k">for</span> <span class="s1">&#39;VM10G.raw&#39;</span> and probing guessed raw.
Automatically detecting the format is dangerous <span class="k">for</span> raw images, write operations on block <span class="m">0</span> will be restricted.
Specify the <span class="s1">&#39;raw&#39;</span> format explicitly to remove the restrictions.
</pre></div>


<p>QEMU window will open. Install FreeBSD.</p>
<h1>Run The VM Using xhyve</h1>
<h2>#1</h2>
<p>Before using xhyve, run the vm using qemu.</p>
<div class="highlight"><pre><span class="nv">$ </span>qemu-system-x86_64 -m <span class="m">256</span> -hda VM10G.raw
</pre></div>


<p>Change GEOM name 'ada0' to 'vtbd0'.</p>
<p>Edit /etc/fstab,</p>
<div class="highlight"><pre># Device        Mountpoint      FStype  Options Dump    Pass#
/dev/ada0p2    /               ufs     rw      1       1
/dev/ada0p3    none            swap    sw      0       0
</pre></div>


<p>To</p>
<div class="highlight"><pre># Device        Mountpoint      FStype  Options Dump    Pass#
/dev/vtbd0p2    /               ufs     rw      1       1
/dev/vtbd0p3    none            swap    sw      0       0
</pre></div>


<p>And set DHCP to vtnet0 interface.</p>
<p>Edit /etc/rc.conf</p>
<div class="highlight"><pre>ifconfig_vtnet0=&quot;DHCP&quot;
</pre></div>


<p>Shut it down and close the qemu window.</p>
<h2>#2</h2>
<p>Create running script.</p>
<p>xhyverun-freebsd.sh</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span class="c">#!/bin/sh</span>

<span class="nv">USERBOOT</span><span class="o">=</span><span class="s2">&quot;/Library/Caches/Homebrew/xhyve--git/test/userboot.so&quot;</span>
<span class="nv">BOOTVOLUME</span><span class="o">=</span><span class="s2">&quot;VM10G.raw&quot;</span>
<span class="nv">KERNELENV</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

<span class="nv">MEM</span><span class="o">=</span><span class="s2">&quot;-m 2G&quot;</span>
<span class="nv">SMP</span><span class="o">=</span><span class="s2">&quot;-c 2&quot;</span>
<span class="nv">IMG_HDD</span><span class="o">=</span><span class="s2">&quot;-s 4:0,virtio-blk,</span><span class="nv">$BOOTVOLUME</span><span class="s2">&quot;</span>
<span class="nv">PCI_DEV</span><span class="o">=</span><span class="s2">&quot;-s 0:0,hostbridge -s 31,lpc&quot;</span>
<span class="nv">LPC_DEV</span><span class="o">=</span><span class="s2">&quot;-l com1,stdio&quot;</span>
<span class="nv">NET</span><span class="o">=</span><span class="s2">&quot;-s 2:0,virtio-net&quot;</span>

<span class="c"># UUID=&quot;-U deaddead-dead-dead-dead-deaddeaddead&quot;</span>

xhyve -A <span class="nv">$MEM</span> <span class="nv">$SMP</span> <span class="nv">$PCI_DEV</span> <span class="nv">$LPC_DEV</span> <span class="nv">$NET</span> <span class="nv">$IMG_CD</span> <span class="nv">$IMG_HDD</span> <span class="nv">$UUID</span> -f fbsd,<span class="nv">$USERBOOT</span>,<span class="nv">$BOOTVOLUME</span>,<span class="s2">&quot;</span><span class="nv">$KERNELENV</span><span class="s2">&quot;</span>
</pre></div>
</td></tr></table>

<p>Run the FreeBSD VM.</p>
<div class="highlight"><pre><span class="nv">$ </span>sudo xhyverun-freebsd.sh


______               ____   _____ _____
<span class="p">|</span>  ____<span class="p">|</span>             <span class="p">|</span>  _ <span class="se">\ </span>/ ____<span class="p">|</span>  __ <span class="se">\</span>
<span class="p">|</span> <span class="p">|</span>___ _ __ ___  ___ <span class="p">|</span> <span class="p">|</span>_<span class="o">)</span> <span class="p">|</span> <span class="o">(</span>___ <span class="p">|</span> <span class="p">|</span>  <span class="p">|</span> <span class="p">|</span>
<span class="p">|</span>  ___<span class="p">|</span> <span class="err">&#39;</span>__/ _ <span class="se">\/</span> _ <span class="se">\|</span>  _ &lt; <span class="se">\_</span>__ <span class="se">\|</span> <span class="p">|</span>  <span class="p">|</span> <span class="p">|</span>
<span class="p">|</span> <span class="p">|</span>   <span class="p">|</span> <span class="p">|</span> <span class="p">|</span>  __/  __/<span class="p">|</span> <span class="p">|</span>_<span class="o">)</span> <span class="p">|</span>____<span class="o">)</span> <span class="p">|</span> <span class="p">|</span>__<span class="p">|</span> <span class="p">|</span>
<span class="p">|</span> <span class="p">|</span>   <span class="p">|</span> <span class="p">|</span> <span class="p">|</span>    <span class="p">|</span>    <span class="o">||</span>     <span class="p">|</span>      <span class="p">|</span>      <span class="p">|</span>
<span class="p">|</span>_<span class="p">|</span>   <span class="p">|</span>_<span class="p">|</span>  <span class="se">\_</span>__<span class="p">|</span><span class="se">\_</span>__<span class="o">||</span>____/<span class="p">|</span>_____/<span class="p">|</span>_____/    <span class="sb">```</span>                        <span class="sb">`</span>
s<span class="sb">`</span> <span class="sb">`</span>.....---.......--.<span class="sb">```</span>   -/
+<span class="o">============</span>Welcome to <span class="nv">FreeBSD</span><span class="o">===========</span>+ +o   .--<span class="sb">`</span>         /y:<span class="sb">`</span>      +.
<span class="p">|</span>                                         <span class="p">|</span>  yo<span class="sb">`</span>:.            :o      <span class="sb">`</span>+-
<span class="p">|</span>  1. Boot Multi User <span class="o">[</span>Enter<span class="o">]</span>             <span class="p">|</span>   y/               -/<span class="sb">`</span>   -o/
<span class="p">|</span>  2. Boot <span class="o">[</span>S<span class="o">]</span>ingle User                  <span class="p">|</span>  .-                  ::/sy+:.
<span class="p">|</span>  3. <span class="o">[</span>Esc<span class="o">]</span>ape to loader prompt           <span class="p">|</span>  /                     <span class="sb">`</span>--  /
<span class="p">|</span>  4. Reboot                              <span class="p">|</span> <span class="sb">`</span>:                          :<span class="sb">`</span>
<span class="p">|</span>                                         <span class="p">|</span> <span class="sb">`</span>:                          :<span class="sb">`</span>
<span class="p">|</span>  Options:                               <span class="p">|</span>  /                          /
<span class="p">|</span>  5. <span class="o">[</span>K<span class="o">]</span>ernel: kernel <span class="o">(</span><span class="m">1</span> of 2<span class="o">)</span>           <span class="p">|</span>  .-                        -.
<span class="p">|</span>  6. Configure Boot <span class="o">[</span>O<span class="o">]</span>ptions...         <span class="p">|</span>   --                      -.
<span class="p">|</span>                                         <span class="p">|</span>    <span class="sb">`</span>:<span class="sb">`</span>                  <span class="sb">`</span>:<span class="sb">`</span>
<span class="p">|</span>                                         <span class="p">|</span>      .--             <span class="sb">`</span>--.
<span class="p">|</span>                                         <span class="p">|</span>         .---.....----.
+<span class="o">=========================================</span>+
</pre></div>


<p>If you got following mount error, you may be forgeting #1.</p>
<div class="highlight"><pre>Trying to mount root from ufs:/dev/ada0p2 [rw]...
mountroot: waiting for device /dev/ada0p2 ...
Mounting from ufs:/dev/ada0p2 failed with error 19.

Loader variables:
vfs.root.mountfrom=ufs:/dev/ada0p2
vfs.root.mountfrom.options=rw

Manual root filesystem specification:
&lt;fstype&gt;:&lt;device&gt; [options]
Mount &lt;device&gt; using filesystem &lt;fstype&gt;
and with the specified (optional) option list.

eg. ufs:/dev/da0s1a
zfs:tank
cd9660:/dev/acd0 ro
(which is equivalent to: mount -t cd9660 -o ro /dev/acd0 /)

?               List valid disk boot devices
.               Yield 1 second (for background tasks)
&lt;empty line&gt;    Abort manual input

mountroot&gt;
</pre></div>


<p>But you can mount device manually.</p>
<div class="highlight"><pre>mountroot&gt; ?

List of GEOM managed disk devices:
gptid/5bebeba9-6364-11e5-abe5-bd56998f3bd1 gptid/5be6a257-6364-11e5-abe5-bd56998f3bd1 ufsid/56050e05aac93398 gptid/5be40c9f-6364-11e5-abe5-bd56998f3bd1 diskid/DISK-BHYVE-1C5B-53F3-EA71p3 diskid/DISK-BHYVE-1C5B-53F3-EA71p2 diskid/DISK-BHYVE-1C5B-53F3-EA71p1 vtbd0p3 vtbd0p2 vtbd0p1 diskid/DISK-BHYVE-1C5B-53F3-EA71 vtbd0

mountroot&gt; ufs:ufsid/56050e05aac93398
</pre></div>


<h1>Mount Host Directory</h1>
<ul>
<li>Referenece https://github.com/mist64/xhyve/issues/45</li>
</ul>
<h3>On Host(192.168.64.1)</h3>
<div class="highlight"><pre><span class="nv">$ </span>sudo touch /etc/exports
<span class="nv">$ </span>sudo emacs /etc/exports
</pre></div>


<p>Edit /etc/exports (<a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man5/exports.5.html">exports(5)</a>)</p>
<div class="highlight"><pre>/PATH/TO/EXPORTDIR -mapall=501 -network 192.168.64.0 -mask 255.255.255.0
</pre></div>


<p>Reread file (<a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man8/nfsd.8.html">nfsd(8)</a>)</p>
<div class="highlight"><pre><span class="nv">$ </span>sudo nfsd update
</pre></div>


<h3>On VM</h3>
<p>Mount</p>
<div class="highlight"><pre># mkdir /usr/home/YOU/host-shared
# sudo mount 192.168.64.1:/PATH/TO/EXPORTDIR /usr/home/YOU/host-shared
</pre></div>


<p>Unmount</p>
<div class="highlight"><pre># mount
/dev/vtbd0p2 on / (ufs, local, journaled soft-updates)
devfs on /dev (devfs, local, multilabel)
192.168.64.1:/PATH/TO/EXPORTDIR on /usr/home/YOU/host-shared (nfs)
# sudo umount 192.168.64.1:/PATH/TO/EXPORTDIR
</pre></div>


<h1>Resizing and Growing Disks</h1>
<ul>
<li>Reference https://www.freebsd.org/doc/handbook/disks-growing.html</li>
</ul>
<p>Resize VM size on Host. This example 10GB -&gt; 15GB.</p>
<div class="highlight"><pre><span class="nv">$ </span>qemu-img resize VM10G.raw 15GB
</pre></div>


<p>Fix disk partitions configuration on VM</p>
<div class="highlight"><pre># gpart show
=&gt;      34  20971453  vtbd0  GPT  (15G) [CORRUPT]
34      1024      1  freebsd-boot  (512K)
1058  19919872      2  freebsd-ufs  (9.5G)
19920930   1048576      3  freebsd-swap  (512M)
20969506      1981         - free -  (991K)

# gpart recover vtbd0
vtbd0 recovered
# gpart show
=&gt;      34  31457213  vtbd0  GPT  (15G)
34      1024      1  freebsd-boot  (512K)
1058  19919872      2  freebsd-ufs  (9.5G)
19920930   1048576      3  freebsd-swap  (512M)
20969506  10487741         - free -  (5.0G)
</pre></div>


<p>Delete swap partition</p>
<div class="highlight"><pre># swapoff /dev/vtbd0p3
# gpart delete -i 3 vtbd0
vtbd0p3 deleted
# gpart show
=&gt;      34  31457213  vtbd0  GPT  (15G)
34      1024      1  freebsd-boot  (512K)
1058  19919872      2  freebsd-ufs  (9.5G)
19920930  11536317         - free -  (5.5G)
</pre></div>


<p>Resize freebsd-ufs partition</p>
<div class="highlight"><pre># gpart resize -i 2 -a 4k -s 14G vtbd0
vtbd0p2 resized
root@xhyve-freebsd:~ # gpart show
=&gt;      34  31457213  vtbd0  GPT  (15G)
34      1024      1  freebsd-boot  (512K)
1058  29360126      2  freebsd-ufs  (14G)
29361184   2096063         - free -  (1.0G)
</pre></div>


<p>Recreate swap partition</p>
<div class="highlight"><pre>#  gpart add -t freebsd-swap -a 4k -s 512M vtbd0
vtbd0p3 added
# gpart show
=&gt;      34  31457213  vtbd0  GPT  (15G)
34      1024      1  freebsd-boot  (512K)
1058  29360126      2  freebsd-ufs  (14G)
29361184   1048576      3  freebsd-swap  (512M)
30409760   1047487         - free -  (511M)

# swapon /dev/vtbd0p3
</pre></div>


<p>Grow the UFS file system</p>
<div class="highlight"><pre># growfs /dev/vtbd0p2
Device is mounted read-write; resizing will result in temporary write suspension for /.
It&#39;s strongly recommended to make a backup before growing the file system.
OK to grow filesystem on /dev/vtbd0p2, mounted on /, from 9.5GB to 14GB? [Yes/No] Yes
super-block backups (for fsck_ffs -b #) at:
20516032, 21798272, 23080512, 24362752, 25644992, 26927232, 28209472
</pre></div>


<p>Check the resized file system.</p>
<div class="highlight"><pre># df -h
Filesystem      Size    Used   Avail Capacity  Mounted on
/dev/vtbd0p2     14G    1.9G     11G    16%    /
devfs           1.0K    1.0K      0B   100%    /dev
</pre></div>


<p>Now's the time to rename VM10G.raw.</p>
<p>It is no longer 10GB... Hahaha.</p>
    </div>
  </div>
    </div>
<footer class="footer">
  <div class="container">
    <p class="text-center">
      May the <a href="https://github.com/tanb/tanb.github.com/tree/source">source</a> be with you, always...
    </p>
    <p class="text-center">
      Copyright © <script type="text/javascript"> document.write(new Date().getFullYear()); </script> tanB |
      Powered by <a href="http://getpelican.com" target="blank">Pelican</a>, <a href="https://pages.github.com" target="blank">GitHub</a>
    </p>
    <div class="text-center" id="google_translate_element"></div>
  </div>
</footer> <!-- /.footer -->
    <script src="https://tanb.me/theme/js/jquery.min.js"></script>
    <script src="https://tanb.me/theme/js/bootstrap.min.js"></script>
  </body> <!-- 42 -->

</html>